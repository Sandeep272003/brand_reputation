<!-- index.html -->
<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Brand Mention & Reputation Tracker — Demo</title>

  <!-- CDN libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root { --glass: rgba(255,255,255,0.04); }
    .glass { background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); backdrop-filter: blur(6px); border: 1px solid rgba(255,255,255,0.03); }
    .avatar { width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,#7c3aed,#06b6d4);display:inline-block; }
    .mention-card:hover { transform: translateY(-6px); box-shadow: 0 12px 30px rgba(2,6,23,0.6); }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-900 to-slate-800 text-slate-100 min-h-screen">
  <div class="max-w-7xl mx-auto p-6">
    <header class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-3xl font-extrabold">Brand Mention & Reputation Tracker</h1>
        <p class="text-slate-400">Real-time monitoring • Sentiment • Topic clustering • Spike alerts</p>
      </div>
      <div class="text-sm text-slate-400 text-right">
        <div>Demo • Node.js + Socket.IO</div>
      </div>
    </header>

    <main class="grid grid-cols-12 gap-6">
      <section class="col-span-8 space-y-6">
        <div class="p-4 glass rounded-2xl">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <div class="avatar"></div>
              <div>
                <div class="text-sm text-slate-400">Live stream</div>
                <div id="liveStatus" class="text-white font-medium">Connected</div>
              </div>
            </div>

            <div class="flex items-center gap-2">
              <input id="quickKeyword" class="px-3 py-2 bg-slate-900 rounded-lg border border-slate-800" placeholder="Add keyword and press Enter"/>
              <button id="exportBtn" class="px-4 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-400">Export CSV</button>
              <button id="toggleSim" class="px-4 py-2 rounded-lg bg-yellow-500 hover:bg-yellow-400">Pause</button>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div class="p-3 bg-slate-900/20 rounded-lg">
              <canvas id="sentChart" height="140"></canvas>
            </div>
            <div class="p-3 bg-slate-900/20 rounded-lg">
              <canvas id="volumeChart" height="140"></canvas>
            </div>
          </div>

          <div class="mt-4">
            <div class="flex items-center justify-between">
              <h2 class="font-semibold">Mention Feed</h2>
              <div class="text-xs text-slate-400" id="feedCount">0 mentions</div>
            </div>
            <div id="feed" class="mt-3 space-y-3 max-h-[520px] overflow-auto pr-2"></div>
          </div>
        </div>
      </section>

      <aside class="col-span-4 space-y-6">
        <div class="p-4 glass rounded-2xl">
          <h3 class="font-semibold">Controls</h3>
          <div class="mt-3">
            <label class="text-sm text-slate-300">Tracked Keywords (comma separated)</label>
            <input id="keywordsBox" class="w-full mt-2 px-3 py-2 rounded-lg bg-slate-900 border border-slate-800" />
            <div class="flex gap-2 mt-3">
              <button id="applyKeywords" class="flex-1 px-3 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500">Apply</button>
              <button id="clearKeywords" class="px-3 py-2 rounded-lg bg-slate-700 hover:bg-slate-600">Clear</button>
            </div>
          </div>

          <div class="mt-4">
            <h4 class="text-sm text-slate-300">Top Topics</h4>
            <div id="topics" class="mt-2 flex gap-2 flex-wrap"></div>
          </div>

          <div class="mt-4">
            <h4 class="text-sm text-slate-300">Alerts</h4>
            <div id="alerts" class="mt-2 space-y-2"></div>
          </div>
        </div>

        <div class="p-4 glass rounded-2xl">
          <h3 class="font-semibold">Quick Insights</h3>
          <div class="grid grid-cols-1 gap-3 mt-3">
            <div class="p-3 rounded-lg bg-slate-900/10">
              <div class="text-sm text-slate-400">Total Mentions</div>
              <div id="totalMentions" class="text-2xl font-bold">0</div>
            </div>
            <div class="p-3 rounded-lg bg-slate-900/10">
              <div class="text-sm text-slate-400">Positive / Neutral / Negative</div>
              <div id="sentBreak" class="text-base font-medium">0 / 0 / 0</div>
            </div>
            <div class="p-3 rounded-lg bg-slate-900/10">
              <div class="text-sm text-slate-400">Last Updated</div>
              <div id="lastUpdated" class="text-xs text-slate-400">—</div>
            </div>
          </div>
        </div>

        <div class="p-4 glass rounded-2xl">
          <h3 class="font-semibold">Pro Tips</h3>
          <ul class="text-sm text-slate-300 mt-2 space-y-2">
            <li>• Add brand/product names as exact keywords to increase relevance.</li>
            <li>• Export CSV to share with stakeholders quickly.</li>
            <li>• Replace simulator with scrapers or APIs for production ingestion.</li>
          </ul>
        </div>
      </aside>
    </main>

    <footer class="mt-8 text-center text-slate-500 text-sm">Demo built for hackathon — separated files for clarity</footer>
  </div>

<script>
  const socket = io();

  // state
  let mentions = [];
  let keywords = [];
  let paused = false;

  // elements
  const feedEl = document.getElementById('feed');
  const totalEl = document.getElementById('totalMentions');
  const sentBreak = document.getElementById('sentBreak');
  const lastUpdated = document.getElementById('lastUpdated');
  const topicsEl = document.getElementById('topics');
  const alertsEl = document.getElementById('alerts');
  const feedCount = document.getElementById('feedCount');

  // charts
  const sentCtx = document.getElementById('sentChart').getContext('2d');
  const volCtx = document.getElementById('volumeChart').getContext('2d');
  const sentChart = new Chart(sentCtx, {
    type: 'doughnut',
    data: { labels: ['positive','neutral','negative'], datasets: [{ data: [0,0,0], hoverOffset:4 }] },
    options: { plugins:{legend:{labels:{color:'#cbd5e1'}}} }
  });
  const volumeChart = new Chart(volCtx, {
    type: 'line',
    data: { labels: [], datasets: [{ label:'mentions/min', data: [], tension:0.3, fill:true }] },
    options: { plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
  });

  function escapeHtml(s){ return s ? s.replace(/[&<>"']/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) : ''; }

  function renderFeed(list = mentions.slice(0,200)){
    feedEl.innerHTML = '';
    list.forEach(m => {
      const div = document.createElement('div');
      div.className = 'mention-card p-3 rounded-xl bg-gradient-to-r from-slate-900/30 to-slate-900/10 border border-slate-800';
      div.innerHTML = `
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-xs text-slate-400">${new Date(m.ts).toLocaleTimeString()}</div>
            <div class="mt-1 font-medium">${escapeHtml(m.text)}</div>
            <div class="text-xs text-slate-400 mt-1">Source: ${escapeHtml(m.source)} • Platform: ${escapeHtml(m.platform)}</div>
          </div>
          <div class="text-right">
            <div class="text-sm font-semibold">${escapeHtml(m.sentimentLabel).toUpperCase()}</div>
            <div class="text-xs text-slate-400">score: ${Number(m.sentimentScore).toFixed(2)}</div>
          </div>
        </div>
      `;
      feedEl.appendChild(div);
    });
    feedCount.textContent = `${mentions.length} mentions`;
  }

  function updateAnalytics(){
    const bySent = {positive:0, neutral:0, negative:0};
    mentions.forEach(m => bySent[m.sentimentLabel] = (bySent[m.sentimentLabel]||0) + 1);
    sentChart.data.datasets[0].data = [bySent.positive, bySent.neutral, bySent.negative];
    sentChart.update();
    totalEl.textContent = mentions.length;
    sentBreak.textContent = `${bySent.positive} / ${bySent.neutral} / ${bySent.negative}`;
    lastUpdated.textContent = new Date().toLocaleString();
  }

  function updateTopics(topics){
    topicsEl.innerHTML = '';
    topics.forEach(t => {
      const btn = document.createElement('button');
      btn.className = 'px-3 py-1 rounded-full bg-slate-700 text-slate-200 text-sm';
      btn.textContent = `${t.label} (${t.count})`;
      btn.onclick = () => {
        const ids = new Set(t.items);
        renderFeed(mentions.filter(m => ids.has(m.id)));
      };
      topicsEl.appendChild(btn);
    });
  }

  function addAlert(msg, tone='warn'){
    const el = document.createElement('div');
    el.className = 'p-2 rounded-lg text-sm ' + (tone === 'warn' ? 'bg-red-700 text-white' : 'bg-emerald-600 text-white');
    el.textContent = msg;
    alertsEl.prepend(el);
    setTimeout(()=> el.remove(), 12000);
  }

  // socket handlers
  socket.on('connect', () => {
    document.getElementById('liveStatus').textContent = 'Connected';
  });

  socket.on('init', (data) => {
    mentions = data.mentions.slice();
    keywords = data.keywords || [];
    document.getElementById('keywordsBox').value = keywords.join(',');
    renderFeed();
    updateAnalytics();
  });

  socket.on('new_mention', (m) => {
    if (paused) return;
    mentions.unshift(m);
    if (mentions.length > 5000) mentions = mentions.slice(0,5000);
    renderFeed();
    updateAnalytics();
    pushVolumePoint();
  });

  socket.on('spike_alert', (a) => addAlert('⚠️ '+a.message, 'warn'));
  socket.on('keywordsUpdated', (k) => { keywords = k; document.getElementById('keywordsBox').value = k.join(','); addAlert('Keywords updated: '+k.join(','), 'ok'); });

  // controls
  document.getElementById('applyKeywords').onclick = async () => {
    const val = document.getElementById('keywordsBox').value;
    const arr = val.split(',').map(s=>s.trim()).filter(Boolean);
    await fetch('/api/keywords', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ keywords: arr })});
    addAlert('Applied keywords: '+arr.join(','), 'ok');
  };
  document.getElementById('clearKeywords').onclick = async () => {
    document.getElementById('keywordsBox').value=''; await fetch('/api/keywords', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ keywords: [] })});
  };

  // quick add
  document.getElementById('quickKeyword').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      const v = e.target.value.trim(); if (!v) return;
      const cur = document.getElementById('keywordsBox').value.split(',').map(s=>s.trim()).filter(Boolean); cur.push(v);
      document.getElementById('keywordsBox').value = cur.join(',');
      fetch('/api/keywords', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ keywords: cur })});
      e.target.value=''; addAlert('Keyword added: '+v, 'ok');
    }
  });

  // toggle simulator
  document.getElementById('toggleSim').onclick = async () => {
    paused = !paused;
    document.getElementById('toggleSim').textContent = paused ? 'Resume' : 'Pause';
    // notify server too so timestamps continue only if server side simulator is toggled
    await fetch('/api/simulator', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ action: paused ? 'stop' : 'start' })});
    addAlert(paused ? 'Stream paused' : 'Stream resumed', paused ? 'warn' : 'ok');
  };

  // volume points
  function pushVolumePoint(){
    const now = Date.now();
    const oneMin = now - 60000;
    const count = mentions.filter(m => m.ts >= oneMin).length;
    const label = new Date().toLocaleTimeString();
    volumeChart.data.labels.push(label);
    volumeChart.data.datasets[0].data.push(count);
    if (volumeChart.data.labels.length > 16) {
      volumeChart.data.labels.shift(); volumeChart.data.datasets[0].data.shift();
    }
    volumeChart.update();
  }
  setInterval(() => pushVolumePoint(), 4000);

  // export CSV
  document.getElementById('exportBtn').onclick = () => {
    window.location.href = '/api/export.csv';
  };

  // periodic topics fetch
  async function refreshTopics(){
    try{
      const r = await fetch('/api/mentions');
      const j = await r.json();
      if (j.topics) updateTopics(j.topics);
    }catch(e){}
  }
  setInterval(refreshTopics, 8000);
  refreshTopics();

</script>
</body>
</html>
